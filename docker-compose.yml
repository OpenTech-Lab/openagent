# ==============================================================================
# OpenAgent Docker Compose Configuration
# ==============================================================================
# Quick start: ./docker-setup.sh
# Manual: docker compose run --rm openagent-cli onboard
# ==============================================================================

services:
  # ============================================================================
  # OpenAgent TUI - Standalone interactive chat (no databases needed)
  # ============================================================================
  openagent-tui:
    build:
      context: .
      dockerfile: Dockerfile
      target: runtime
    container_name: openagent-tui
    stdin_open: true
    tty: true
    entrypoint: ["openagent-tui"]
    volumes:
      - ./.env:/app/.env:ro
      - ./SOUL.md:/app/SOUL.md
      - ./workspace:/app/workspace
      - openagent-model-cache:/app/.cache
    environment:
      - RUST_LOG=${RUST_LOG:-warn,openagent=info}
    networks:
      - openagent-network

  # ============================================================================
  # OpenAgent CLI - Interactive command-line interface
  # ============================================================================
  openagent-cli:
    build:
      context: .
      dockerfile: Dockerfile
      target: runtime
    container_name: openagent-cli
    stdin_open: true
    tty: true
    volumes:
      - ./.env:/app/.env:ro
      - ./SOUL.md:/app/SOUL.md
      - ./workspace:/app/workspace
      - openagent-model-cache:/app/.cache
      - /var/run/docker.sock:/var/run/docker.sock
    environment:
      - RUST_LOG=${RUST_LOG:-info,openagent=debug}
      - DATABASE_URL=postgres://openagent:openagent@openagent-postgres:5432/openagent
    depends_on:
      openagent-postgres:
        condition: service_healthy
    networks:
      - openagent-network

  # ============================================================================
  # OpenAgent Gateway - WebSocket/HTTP API server
  # ============================================================================
  openagent-gateway:
    build:
      context: .
      dockerfile: Dockerfile
      target: gateway
    container_name: openagent-gateway
    ports:
      - "${GATEWAY_PORT:-8080}:8080"
    volumes:
      - ./.env:/app/.env:ro
      - ./SOUL.md:/app/SOUL.md
      - ./workspace:/app/workspace
      - openagent-model-cache:/app/.cache
      - /var/run/docker.sock:/var/run/docker.sock
    environment:
      - RUST_LOG=${RUST_LOG:-info,openagent=debug}
      - DATABASE_URL=postgres://openagent:openagent@openagent-postgres:5432/openagent
    depends_on:
      openagent-postgres:
        condition: service_healthy
    networks:
      - openagent-network
    restart: unless-stopped

  # ============================================================================
  # PostgreSQL with pgvector extension
  # ============================================================================
  openagent-postgres:
    image: pgvector/pgvector:pg16
    container_name: openagent-postgres
    environment:
      POSTGRES_USER: openagent
      POSTGRES_PASSWORD: openagent
      POSTGRES_DB: openagent
    volumes:
      - openagent-postgres-data:/var/lib/postgresql/data
    ports:
      - "${POSTGRES_PORT:-5432}:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U openagent -d openagent"]
      interval: 5s
      timeout: 5s
      retries: 5
    networks:
      - openagent-network
    restart: unless-stopped

# ==============================================================================
# Networks
# ==============================================================================
networks:
  openagent-network:
    driver: bridge

# ==============================================================================
# Volumes
# ==============================================================================
volumes:
  openagent-postgres-data:
  openagent-model-cache:
